{% load humanize %}
<!DOCTYPE html>
<html>
<head>
  <title>MGNREGA Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 0;
    }

    h2 {
      text-align: center;
      margin-top: 20px;
      color: #343a40;
      font-weight: 600;
    }

    .card {
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-5px);
    }

    .card h3 {
      margin-top: 10px;
      font-size: 1.8rem;
      font-weight: 700;
    }

    .filter-form select, .filter-form button {
      min-width: 150px;
    }

    .dataTables_wrapper .dt-buttons {
      float: left;
      margin-bottom: 10px;
    }

    table.dataTable {
      width: 100% !important;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    table.dataTable thead {
      background-color: #0d6efd;
      color: white;
    }

    table.dataTable th, table.dataTable td {
      text-align: center;
      padding: 12px;
    }

    .badge {
      font-size: 0.85rem;
      padding: 0.4em 0.7em;
    }

    /* Chart Container */
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .card h3 {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body>

<h2>MGNREGA Data Dashboard</h2>

<!-- Dashboard Cards -->
<div class="container my-4">
  <div class="row text-center g-3">
    <div class="col-md-4">
      <div class="card bg-primary text-white">
        <h5>Total Households</h5>
        <h3>{{ total_households|intcomma }}</h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-success text-white">
        <h5>Total Persondays</h5>
        <h3>{{ total_persondays|intcomma }}</h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-warning text-dark">
        <h5>Avg Expenditure (Lakhs)</h5>
        <h3>{{ avg_expenditure|floatformat:2 }} L</h3>
      </div>
    </div>
  </div>
</div>

<!-- Filter Form -->
<div class="container mb-4">
  <form method="get" class="row g-3 justify-content-center filter-form">
    <div class="col-auto">
      <select name="district" class="form-select">
        <option value="">All Districts</option>
        {% for d in districts %}
          <option value="{{ d }}" {% if d == selected_district %}selected{% endif %}>{{ d }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <select name="year" class="form-select">
        <option value="">All Years</option>
        {% for y in years %}
          <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Filter</button>
    </div>
  </form>
</div>

<!-- Data Table -->
<div class="container mb-5">
  <table id="mgnregaTable" class="display nowrap">
    <thead>
        <tr>
          <th>District</th>
          <th>Financial Year</th>
          <th>Households</th>
          <th>Persondays</th>
          <th>Avg Days/HH</th>
          <th>Expenditure (Lakhs)</th>
        </tr>
    </thead>
    <tbody>
    {% for item in data %}
        <tr>
            <td>{{ item.district }}</td>
            <td>{{ item.fin_year }}</td>
            <td>{{ item.total_individuals_worked|intcomma }}</td>
            <td>{{ item.women_persondays|intcomma }}</td>
            <td>
              {% if item.avg_days_employment < 30 %}
                <span class="badge bg-danger">{{ item.avg_days_employment|floatformat:2 }}</span>
              {% elif item.avg_days_employment <= 50 %}
                <span class="badge bg-warning text-dark">{{ item.avg_days_employment|floatformat:2 }}</span>
              {% else %}
                <span class="badge bg-success">{{ item.avg_days_employment|floatformat:2 }}</span>
              {% endif %}
            </td>
            <td>
              {% if item.wages_lakhs < 10 %}
                <span class="badge bg-info text-dark">{{ item.wages_lakhs|floatformat:2 }} L</span>
              {% elif item.wages_lakhs <= 50 %}
                <span class="badge bg-primary">{{ item.wages_lakhs|floatformat:2 }} L</span>
              {% else %}
                <span class="badge bg-success">{{ item.wages_lakhs|floatformat:2 }} L</span>
              {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<!-- Charts -->
<div class="container">
  <div class="row">
    <div class="col-md-6 chart-container">
      <canvas id="expenditureChart"></canvas>
    </div>
    <div class="col-md-6 chart-container">
      <canvas id="persondaysChart"></canvas>
    </div>
    <div class="col-md-12 chart-container">
      <canvas id="avgDaysChart"></canvas>
    </div>
  </div>
</div>

<!-- JS Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(document).ready(function() {
    $('#mgnregaTable').DataTable({
        "pageLength": 10,
        "lengthChange": false,
        "scrollX": true,
        dom: 'Bfrtip',
        buttons: ['csvHtml5']
    });
});

// Charts
function createChart(ctxId, label, dataValues, bgColor, borderColor, type='bar') {
  const ctx = document.getElementById(ctxId).getContext('2d');
  return new Chart(ctx, {
      type: type,
      data: {
          labels: [{% for item in data %}'{{ item.district }}',{% endfor %}],
          datasets: [{
              label: label,
              data: dataValues,
              backgroundColor: bgColor,
              borderColor: borderColor,
              borderWidth: 1,
              fill: type==='line'
          }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
}

createChart('expenditureChart','Expenditure (Lakhs)',
  [{% for item in data %}{{ item.wages_lakhs }},{% endfor %}],
  'rgba(75, 192, 192, 0.4)',
  'rgba(75, 192, 192, 1)'
);

createChart('persondaysChart','Persondays',
  [{% for item in data %}{{ item.women_persondays }},{% endfor %}],
  'rgba(255, 206, 86, 0.4)',
  'rgba(255, 206, 86, 1)'
);

createChart('avgDaysChart','Avg Days/HH',
  [{% for item in data %}{{ item.avg_days_employment }},{% endfor %}],
  'rgba(54, 162, 235, 0.2)',
  'rgba(54, 162, 235, 1)',
  'line'
);
</script>

</body>
</html>
